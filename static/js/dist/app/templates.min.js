var templates=[],icons={"application/vnd.ms-excel":"fa-file-excel-o","text/plain":"fa-file-text-o","image/gif":"fa-file-image-o","image/png":"fa-file-image-o","application/pdf":"fa-file-pdf-o","application/x-zip-compressed":"fa-file-archive-o","application/x-gzip":"fa-file-archive-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/octet-stream":"fa-file-o","application/x-msdownload":"fa-file-o"};function save(e){var a={attachments:[]};a.name=$("#name").val(),a.subject=$("#subject").val(),a.envelope_sender=$("#envelope-sender").val(),a.html=CKEDITOR.instances.html_editor.getData(),a.html=a.html.replace(/https?:\/\/{{\.URL}}/gi,"{{.URL}}"),$("#use_tracker_checkbox").prop("checked")?-1==a.html.indexOf("{{.Tracker}}")&&-1==a.html.indexOf("{{.TrackingUrl}}")&&(a.html=a.html.replace("</body>","{{.Tracker}}</body>")):a.html=a.html.replace("{{.Tracker}}</body>","</body>"),a.text=$("#text_editor").val(),$.each($("#attachmentsTable").DataTable().rows().data(),(function(e,t){a.attachments.push({name:unescapeHtml(t[1]),content:t[3],type:t[4]})})),-1!=e?(a.id=templates[e].id,api.templateId.put(a).success((function(e){successFlash("Template edited successfully!"),load(),dismiss()})).error((function(e){modalError(e.responseJSON.message)}))):api.templates.post(a).success((function(e){successFlash("Template added successfully!"),load(),dismiss()})).error((function(e){modalError(e.responseJSON.message)}))}function dismiss(){$("#modal\\.flashes").empty(),$("#attachmentsTable").dataTable().DataTable().clear().draw(),$("#name").val(""),$("#subject").val(""),$("#text_editor").val(""),$("#html_editor").val(""),$("#modal").modal("hide")}var deleteTemplate=function(e){Swal.fire({title:"Are you sure?",text:"This will delete the template. This can't be undone!",type:"warning",animation:!1,showCancelButton:!0,confirmButtonText:"Delete "+escapeHtml(templates[e].name),confirmButtonColor:"#428bca",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise((function(a,t){api.templateId.delete(templates[e].id).success((function(e){a()})).error((function(e){t(e.responseJSON.message)}))}))}}).then((function(e){e.value&&Swal.fire("Template Deleted!","This template has been deleted!","success"),$('button:contains("OK")').on("click",(function(){location.reload()}))}))};function deleteTemplate(e){confirm("Delete "+templates[e].name+"?")&&api.templateId.delete(templates[e].id).success((function(e){successFlash(e.message),load()}))}function attach(e){attachmentsTable=$("#attachmentsTable").DataTable({destroy:!0,order:[[1,"asc"]],columnDefs:[{orderable:!1,targets:"no-sort"},{sClass:"datatable_hidden",targets:[3,4]}]}),$.each(e,(function(e,a){var t=new FileReader;t.onload=function(e){var o=icons[a.type]||"fa-file-o";attachmentsTable.row.add(['<i class="fa '+o+'"></i>',escapeHtml(a.name),'<span class="remove-row"><i class="fa fa-trash-o"></i></span>',t.result.split(",")[1],a.type||"application/octet-stream"]).draw()},t.onerror=function(e){console.log(e)},t.readAsDataURL(a)}))}function edit(e){$("#modalSubmit").unbind("click").click((function(){save(e)})),$("#attachmentUpload").unbind("click").click((function(){this.value=null})),$("#html_editor").ckeditor(),setupAutocomplete(CKEDITOR.instances.html_editor),$("#attachmentsTable").show(),attachmentsTable=$("#attachmentsTable").DataTable({destroy:!0,order:[[1,"asc"]],columnDefs:[{orderable:!1,targets:"no-sort"},{sClass:"datatable_hidden",targets:[3,4]}]});var a={attachments:[]};-1!=e?($("#templateModalLabel").text("Edit Template"),a=templates[e],$("#name").val(a.name),$("#subject").val(a.subject),$("#envelope-sender").val(a.envelope_sender),$("#html_editor").val(a.html),$("#text_editor").val(a.text),attachmentRows=[],$.each(a.attachments,(function(e,a){var t=icons[a.type]||"fa-file-o";attachmentRows.push(['<i class="fa '+t+'"></i>',escapeHtml(a.name),'<span class="remove-row"><i class="fa fa-trash-o"></i></span>',a.content,a.type||"application/octet-stream"])})),attachmentsTable.rows.add(attachmentRows).draw(),-1!=a.html.indexOf("{{.Tracker}}")?$("#use_tracker_checkbox").prop("checked",!0):$("#use_tracker_checkbox").prop("checked",!1)):$("#templateModalLabel").text("New Template"),$("#attachmentsTable").unbind("click").on("click","span>i.fa-trash-o",(function(){attachmentsTable.row($(this).parents("tr")).remove().draw()}))}function copy(e){$("#modalSubmit").unbind("click").click((function(){save(-1)})),$("#attachmentUpload").unbind("click").click((function(){this.value=null})),$("#html_editor").ckeditor(),$("#attachmentsTable").show(),attachmentsTable=$("#attachmentsTable").DataTable({destroy:!0,order:[[1,"asc"]],columnDefs:[{orderable:!1,targets:"no-sort"},{sClass:"datatable_hidden",targets:[3,4]}]});var a={attachments:[]};a=templates[e],$("#name").val("Copy of "+a.name),$("#subject").val(a.subject),$("#envelope-sender").val(a.envelope_sender),$("#html_editor").val(a.html),$("#text_editor").val(a.text),$.each(a.attachments,(function(e,a){var t=icons[a.type]||"fa-file-o";attachmentsTable.row.add(['<i class="fa '+t+'"></i>',escapeHtml(a.name),'<span class="remove-row"><i class="fa fa-trash-o"></i></span>',a.content,a.type||"application/octet-stream"]).draw()})),$("#attachmentsTable").unbind("click").on("click","span>i.fa-trash-o",(function(){attachmentsTable.row($(this).parents("tr")).remove().draw()})),-1!=a.html.indexOf("{{.Tracker}}")?$("#use_tracker_checkbox").prop("checked",!0):$("#use_tracker_checkbox").prop("checked",!1)}function importEmail(){raw=$("#email_content").val(),convert_links=$("#convert_links_checkbox").prop("checked"),raw?api.import_email({content:raw,convert_links:convert_links}).success((function(e){$("#text_editor").val(e.text),$("#html_editor").val(e.html),$("#subject").val(e.subject),e.html&&(CKEDITOR.instances.html_editor.setMode("wysiwyg"),$('.nav-tabs a[href="#html"]').click()),$("#importEmailModal").modal("hide")})).error((function(e){modalError(e.responseJSON.message)})):modalError("No Content Specified!")}function openAIModal(){$("#generateAIModal\\.flashes").empty()}function generateAITemplate(){var e=$("#ai_scenario").val(),a=$("#ai_target_company").val(),t=$("#ai_include_landing_page").prop("checked");a||(a="Your Organization");var o=$("#generateAIButton").html();$("#generateAIButton").html('<i class="fa fa-spinner fa-spin"></i> Generating...'),$("#generateAIButton").prop("disabled",!0),$("#generateAIModal\\.flashes").empty();var n=Date.now();setTimeout((function(){var s=t?'<h4 style="color: #333;">Generating AI Template & Landing Page...</h4>':'<h4 style="color: #333;">Generating AI Template...</h4>';$("#generateAIModal .modal-body").append('<div id="ai-loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; align-items: center; justify-content: center;"><div style="text-align: center;"><i class="fa fa-spinner fa-spin fa-3x" style="color: #0066cc; margin-bottom: 15px;"></i>'+s+'<p style="color: #666;">This may take a few seconds</p></div></div>'),$("#ai_scenario").prop("disabled",!0),$("#ai_target_company").prop("disabled",!0),$("#ai_include_landing_page").prop("disabled",!0),api.templates.generate_ai({scenario:e,target_company:a,include_landing_page:t}).success((function(s){var l=Date.now()-n,i=Math.max(0,2e3-l);setTimeout((function(){$("#ai-loading-overlay").remove(),$("#ai_scenario").prop("disabled",!1),$("#ai_target_company").prop("disabled",!1),$("#ai_include_landing_page").prop("disabled",!1);var n="AI Generated - "+({password_reset:"Password Reset",urgent_action:"Urgent Action Required",account_verification:"Account Verification",security_alert:"Security Alert",document_share:"Document Shared",invoice:"Invoice/Payment",it_support:"IT Support",hr_announcement:"HR Announcement"}[e]||"Phishing Template")+" - "+a;if(t&&s.landing_page){var l=n+" - Landing Page",i={name:l,html:s.landing_page,capture_credentials:!0,capture_passwords:!0,redirect_url:"https://example.com"};api.pages.post(i).success((function(e){successFlash("Landing page '"+l+"' created successfully!")})).error((function(e){errorFlash("Failed to create landing page: "+(e.responseJSON?e.responseJSON.message:"Unknown error"))}))}$("#generateAIModal").modal("hide"),$("#generateAIButton").html(o),$("#generateAIButton").prop("disabled",!1),edit(-1),$("#modal").modal("show");var c=({password_reset:"Security Team",urgent_action:"Security Alerts",account_verification:"Account Services",security_alert:"IT Security",document_share:"Document Services",invoice:"Accounts Payable",it_support:"IT Support",hr_announcement:"Human Resources"}[e]||"System Administrator")+" <"+({password_reset:"noreply@security-team.com",urgent_action:"alerts@company-security.com",account_verification:"verify@account-services.com",security_alert:"security@it-department.com",document_share:"noreply@document-share.com",invoice:"billing@accounts-payable.com",it_support:"support@it-helpdesk.com",hr_announcement:"hr@human-resources.com"}[e]||"noreply@company.com")+">";$("#name").val(n),$("#envelope-sender").val(c),$("#subject").val(s.subject),$("#text_editor").val(s.text),$("#html_editor").val(s.html),s.html&&(CKEDITOR.instances.html_editor.setMode("wysiwyg"),$('.nav-tabs a[href="#html"]').click());var r=t&&s.landing_page?'<div style="text-align:center" class="alert alert-success">                <i class="fa fa-check-circle"></i> AI template and landing page generated successfully!</div>':'<div style="text-align:center" class="alert alert-success">                <i class="fa fa-check-circle"></i> AI template generated successfully!</div>';$("#modal\\.flashes").empty().append(r)}),i)})).error((function(e){$("#ai-loading-overlay").remove(),$("#ai_scenario").prop("disabled",!1),$("#ai_target_company").prop("disabled",!1),$("#ai_include_landing_page").prop("disabled",!1),$("#generateAIButton").html(o),$("#generateAIButton").prop("disabled",!1);var a="Failed to generate template";e.responseJSON&&e.responseJSON.message&&(a=e.responseJSON.message),$("#generateAIModal\\.flashes").empty().append('<div style="text-align:center" class="alert alert-danger">            <i class="fa fa-exclamation-circle"></i> '+a+"</div>")}))}),100)}function load(){$("#templateTable").hide(),$("#emptyMessage").hide(),$("#loading").show(),api.templates.get().success((function(e){templates=e,$("#loading").hide(),templates.length>0?($("#templateTable").show(),templateTable=$("#templateTable").DataTable({destroy:!0,columnDefs:[{orderable:!1,targets:"no-sort"}]}),templateTable.clear(),templateRows=[],$.each(templates,(function(e,a){templateRows.push([escapeHtml(a.name),moment(a.modified_date).format("MMMM Do YYYY, h:mm:ss a"),"<div class='pull-right'><span data-toggle='modal' data-backdrop='static' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Edit Template' onclick='edit("+e+")'>                    <i class='fa fa-pencil'></i>                    </button></span>\t\t    <span data-toggle='modal' data-target='#modal'><button class='btn btn-primary' data-toggle='tooltip' data-placement='left' title='Copy Template' onclick='copy("+e+")'>                    <i class='fa fa-copy'></i>                    </button></span>                    <button class='btn btn-danger' data-toggle='tooltip' data-placement='left' title='Delete Template' onclick='deleteTemplate("+e+")'>                    <i class='fa fa-trash-o'></i>                    </button></div>"])})),templateTable.rows.add(templateRows).draw(),$('[data-toggle="tooltip"]').tooltip()):$("#emptyMessage").show()})).error((function(){$("#loading").hide(),errorFlash("Error fetching templates")}))}$(document).ready((function(){$(".modal").on("hidden.bs.modal",(function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)})),$(".modal").on("shown.bs.modal",(function(e){void 0===$("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))})),$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy((function(e){this.$element[0]===e.target||this.$element.has(e.target).length||$(e.target).closest(".cke_dialog, .cke").length||this.$element.trigger("focus")}),this))},$(document).on("hidden.bs.modal",".modal",(function(){$(".modal:visible").length&&$(document.body).addClass("modal-open")})),$("#modal").on("hidden.bs.modal",(function(e){dismiss()})),$("#importEmailModal").on("hidden.bs.modal",(function(e){$("#email_content").val("")})),CKEDITOR.on("dialogDefinition",(function(e){var a=e.data.name,t=e.data.definition;"link"==a&&(t.minWidth=500,t.minHeight=100,t.getContents("info").get("linkType").hidden=!0)})),load()}));